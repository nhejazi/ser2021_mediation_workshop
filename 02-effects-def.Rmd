# Path-specific casual mediation effect types {#estimands}

- Controlled direct effects
- Natural direct and indirect effects
- Interventional direct and indirect effects

```{r, engine="tikz", fig.cap = "Directed acyclic graph under *no intermediate confounders* of the mediator-outcome relation affected by treatment", fig.ext=if (knitr:::is_latex_output()) "pdf" else "png", echo = FALSE}
\dimendef\prevdepth=0
\pgfdeclarelayer{background}
\pgfsetlayers{background,main}
\usetikzlibrary{arrows,positioning}
\tikzset{
>=stealth',
punkt/.style={
rectangle,
rounded corners,
draw=black, very thick,
text width=6.5em,
minimum height=2em,
text centered},
pil/.style={
->,
thick,
shorten <=2pt,
shorten >=2pt,}
}
\newcommand{\Vertex}[2]
{\node[minimum width=0.6cm,inner sep=0.05cm] (#2) at (#1) {$#2$};
}
\newcommand{\VertexR}[2]
{\node[rectangle, draw, minimum width=0.6cm,inner sep=0.05cm] (#2) at (#1) {$#2$};
}
\newcommand{\ArrowR}[3]
{ \begin{pgfonlayer}{background}
\draw[->,#3] (#1) to[bend right=30] (#2);
\end{pgfonlayer}
}
\newcommand{\ArrowL}[3]
{ \begin{pgfonlayer}{background}
\draw[->,#3] (#1) to[bend left=45] (#2);
\end{pgfonlayer}
}
\newcommand{\EdgeL}[3]
{ \begin{pgfonlayer}{background}
\draw[dashed,#3] (#1) to[bend right=-45] (#2);
\end{pgfonlayer}
}
\newcommand{\Arrow}[3]
{ \begin{pgfonlayer}{background}
\draw[->,#3] (#1) -- +(#2);
\end{pgfonlayer}
}
\begin{tikzpicture}
  \Vertex{-4, 0}{W}
  \Vertex{0, 0}{M}
  \Vertex{-2, 0}{A}
  \Vertex{2, 0}{Y}
  \Arrow{W}{A}{black}
  \Arrow{A}{M}{black}
  \Arrow{M}{Y}{black}
  \ArrowL{W}{Y}{black}
  \ArrowL{A}{Y}{black}
  \ArrowL{W}{M}{black}
\end{tikzpicture}
```

## Controlled direct effects

- Set the mediator to a reference value $M=m$ uniformly for everyone in the population
- Compare $A=1$ vs $A=0$ with $M=m$ fixed

$$\psi_{\text{CDE}} = \E(Y_{1,m} - Y_{0,m}) $$

### Identification assumptions:
- Confounder assumptions:
  + $A \indep Y_{a,m} \mid W$
  + $M \indep Y_{a,m} \mid W, A$
- Positivity assumptions:
  + $\P(M = m \mid A=a, W) > 0 \text{  } a.e.$
  + $\P(A=a \mid W) > 0 \text{  } a.e.$

Under the above identification assumptions, the controlled direct can be identified:
$$ \E(Y_{1,m} - Y_{0,m}) = \E\{\color{ForestGreen}{\E(Y \mid A=1, M=m, W) - \E(Y \mid A=0, M=m, W)}\}$$

- For intuition about this formula in R, let's continue with our toy example, where we now add an indirect effect
```{r, echo = TRUE, eval = TRUE, cache = TRUE}
n <- 1e7
w <- rnorm(n)
a <- rbinom(n, 1, 0.5)
m <- rnorm(n, w + a)
y <- rnorm(n, w - a + m)
```
- First we fit a correct model for the outcome
```{r, echo = TRUE, eval = TRUE, cache = TRUE}
lm_y <- lm(y ~ m + a + w)
```
- Assume we would like the CDE at $m=0$
- Then we generate predictions \[\color{ForestGreen}{\E(Y \mid A=1, M=m, W)} \text{ and }\color{ForestGreen}{\E(Y \mid A=0, M=m, W)}:\]
```{r, echo = TRUE, eval = TRUE, cache = TRUE}
pred_y1 <- predict(lm_y, newdata = data.frame(a = 1, m = 0, w = w))
pred_y0 <- predict(lm_y, newdata = data.frame(a = 0, m = 0, w = w))
```
- Then we compute the difference between the predicted values $\color{ForestGreen}{\E(Y \mid A=1, M=m, W) - \E(Y \mid A=0, M=m, W)}$, and average across values of $W$
```{r, echo = TRUE, eval = TRUE, cache = TRUE}
## CDE at m = 0
mean(pred_y1 - pred_y0)
```

<!--
ID: Reminder to ask Kara about the purpose of these cartoons
-->

```{r pressure, echo=FALSE, fig.cap="", fig.ext=if (knitr:::is_latex_output()) "pdf" else "png", out.width = "50%", results="asis"}
knitr::include_graphics(here::here("img", "graphic4a3.png"))
```

### Is this the estimand I want?

+ Makes the most sense if can intervene directly on $M$
  + And can think of a policy that would set everyone to a single constant
    level $m \in \mathcal{M}$.
  + J. Pearl calls this _prescriptive_.
  + Can you think of an example?
  + Air pollution, rescue inhaler dosage, hospital visits
  + Does not provide a decomposition of the average treatment effect into direct and indirect effects

_What if our research question doesn't involve intervening directly on the
mediator?_

_What if we want to decompose the average treatment effect into its direct and
indirect counterparts?_

## Natural direct and indirect effects

Still using the same DAG as above,

- Recall the definition of the nested counterfactual

\begin{equation*}
    Y_{1, M_0} = f_Y(W, 1, Z_1, M_0, U_Y)
\end{equation*}

- Interpreted as _the outcome for an individual in a hypothetical world where
  treatment was given but the mediator was held at the value it would have
  taken under no treatment_
  
- Recal that, because of the definition of counterfactuals
\begin{equation*}
  Y_{1, M_1} = Y_1
\end{equation*}

Then we can decompose the _average treatment effect_ $E(Y_1-Y_0)$ as follows

\begin{equation*}
\E[Y_{1,M_1} - Y_{0,M_0}] = \underbrace{\E[Y_{\color{red}{1},\color{blue}{M_1}} -
    Y_{\color{red}{1},\color{blue}{M_0}}]}_{\text{natural indirect effect}} +
    \underbrace{\E[Y_{\color{blue}{1},\color{red}{M_0}} -
    Y_{\color{blue}{0},\color{red}{M_0}}]}_{\text{natural direct effect}}
\end{equation*}

- Natural direct effect (NDE): Varying treatment while keeping the mediator fixed at the value it would have taken under no treatment
- Natural indirect effect (NIE): Varying the mediator from the value it would have taken under treatment to the value it would have taken under control, while keeping treatment fixed

<!--
ID: I still think the below is wrong. M could not possibly be an effect modifier of A -> Y because it comes after Y
I suggest we delete this
-->
- If no effect modification of the effect of $A$ on $Y$ by $M$ (i.e., no interaction between $A$ and $M$), then CDE = NDE.

```{r , echo=FALSE, fig.cap="", fig.ext=if (knitr:::is_latex_output()) "pdf" else "png", out.width = "50%", results="asis"}
knitr::include_graphics(here::here("img", "graphic4a.png"))
```

### Identification assumptions:

- $A \indep Y_{a,m} \mid W$
- $M \indep Y_{a,m} \mid W, A$
- $A \indep M_a \mid W$
- $M_0 \indep Y_{1,m} \mid W$
- and positivity assumptions

### An alternative parameter of interest: the weighted average of controlled direct effects at each level of $M=m$.

\[\E \sum_m \{\E(Y_{1,m} \mid W) - \E(Y_{0,m} \mid W)\} \P(M_{0}=m
\mid W)\]

- If the cross-world assumption holds, this weighted average is equal to the NDE
- The average may be an interest parameter even if cross-world assumption does not hold

### Identification formula:

- Under the above identification assumptions, the natural direct effect can be identified:

\begin{equation*}
\E(Y_{1,M_0} - Y_{0,M_0}) =
  \E[\color{Goldenrod}{\E\{}\color{ForestGreen}{\E(Y \mid A=1, M, W) - \E(Y \mid A=0, M, W)}\color{Goldenrod}{\mid A=0,W\}}]
\end{equation*}

- The natural indirect effect can be identified similarly.

- Let's dissect this formula in R:
```{r, echo = TRUE, eval = TRUE, cache = TRUE}
n <- 1e7
w <- rnorm(n)
a <- rbinom(n, 1, 0.5)
m <- rnorm(n, w + a)
y <- rnorm(n, w - a + m)
```
- First we fit a correct model for the outcome
```{r, echo = TRUE, eval = TRUE, cache = TRUE}
lm_y <- lm(y ~ m + a + w)
```
- Then we generate predictions
\[\color{ForestGreen}{\E(Y \mid A=1, M, W)} \text{ and }\color{ForestGreen}{\E(Y \mid A=0, M, W)}\] with $A$ fixed but letting $M$ and $W$ take their observed values 
```{r, echo = TRUE, eval = TRUE, cache = TRUE}
pred_y1 <- predict(lm_y, newdata = data.frame(a = 1, m = m, w = w))
pred_y0 <- predict(lm_y, newdata = data.frame(a = 0, m = m, w = w))
```
- Then we compute the difference between the predicted values
\[\color{ForestGreen}{\E(Y \mid A=1, M, W) - \E(Y \mid A=0, M, W)},\]
- and use this difference as a pseudo-outcome in a regression on $A$ and $W$:
\[\color{Goldenrod}{\E\{}\color{ForestGreen}{\E(Y \mid A=1, M, W) - \E(Y \mid A=0, M, W)}\color{Goldenrod}{\mid A=0,W\}}\]
```{r, echo = TRUE, eval = TRUE, cache = TRUE}
pseudo <- pred_y1 - pred_y0
lm_pseudo <- lm(pseudo ~ a + m)
```
- Now we predict the value of this pseudo-outcome under $A=0$, and average the result
```{r, echo = TRUE, eval = TRUE, cache = TRUE}
pred_pseudo <- predict(lm_pseudo, newdata = data.frame(a = 0, w = w))
## NDE:
mean(pred_pseudo)
```

### Cross-world independence assumption

What does $M_0 \indep Y_{1,m} \mid W$ mean?

- Conditional on $W$, knowledge of the mediator value in the absence of treatment, $M_0$,
  provides no information about the outcome under treatment, $Y_{1,m}$.
- Can you think of a data-generating mechanism that would violate this
  assumption?
- Example: in a randomized study, whenever we believe that treatment assignment works through adherence (i.e., almost
  always), we are violating this assumption (more on this later). 

### Is this the estimand I want?

- Makes sense to intervene on $A$ but not directly on $M$.
- Want to understand a natural mechanism underlying an association/ total
  effect. J. Pearl calls this _descriptive_.
- NDE + NIE = total effect (ATE).
- Okay with the assumptions.
<!--
NH: Should we mention cross-world indep and indentifiability issues in RCTs?
-->

_What if our data structure involves a post-treatment confounder of the
mediator-outcome relationship (e.g., adherence)?_

```{r, engine="tikz", fig.cap = "Directed acyclic graph under intermediate confounders of the mediator-outcome relation affected by treatment", fig.ext=if (knitr:::is_latex_output()) "pdf" else "png", echo = FALSE}
\dimendef\prevdepth=0
\pgfdeclarelayer{background}
\pgfsetlayers{background,main}
\usetikzlibrary{arrows,positioning}
\tikzset{
>=stealth',
punkt/.style={
rectangle,
rounded corners,
draw=black, very thick,
text width=6.5em,
minimum height=2em,
text centered},
pil/.style={
->,
thick,
shorten <=2pt,
shorten >=2pt,}
}
\newcommand{\Vertex}[2]
{\node[minimum width=0.6cm,inner sep=0.05cm] (#2) at (#1) {$#2$};
}
\newcommand{\VertexR}[2]
{\node[rectangle, draw, minimum width=0.6cm,inner sep=0.05cm] (#2) at (#1) {$#2$};
}
\newcommand{\ArrowR}[3]
{ \begin{pgfonlayer}{background}
\draw[->,#3] (#1) to[bend right=30] (#2);
\end{pgfonlayer}
}
\newcommand{\ArrowL}[3]
{ \begin{pgfonlayer}{background}
\draw[->,#3] (#1) to[bend left=45] (#2);
\end{pgfonlayer}
}
\newcommand{\EdgeL}[3]
{ \begin{pgfonlayer}{background}
\draw[dashed,#3] (#1) to[bend right=-45] (#2);
\end{pgfonlayer}
}
\newcommand{\Arrow}[3]
{ \begin{pgfonlayer}{background}
\draw[->,#3] (#1) -- +(#2);
\end{pgfonlayer}
}
\begin{tikzpicture}
  \Vertex{0, -1}{Z}
  \Vertex{-4, 0}{W}
  \Vertex{0, 0}{M}
  \Vertex{-2, 0}{A}
  \Vertex{2, 0}{Y}
  \ArrowR{W}{Z}{black}
  \Arrow{Z}{M}{black}
  \Arrow{W}{A}{black}
  \Arrow{A}{M}{black}
  \Arrow{M}{Y}{black}
  \Arrow{A}{Z}{black}
  \Arrow{Z}{Y}{black}
  \ArrowL{W}{Y}{black}
  \ArrowL{A}{Y}{black}
  \ArrowL{W}{M}{black}
\end{tikzpicture}
```

```{r , echo=FALSE, fig.cap="", fig.ext=if (knitr:::is_latex_output()) "pdf" else "png", out.width = "100%", results="asis"}
knitr::include_graphics(here::here("img", "ctndag.png"))
```

### Unidentifiability of the NDE and NIE in this setting

- In this example, natural direct and indirect effects are
unidentifiable from observed data on $(W,A,Z,M,Y)$.
- The technical
reason for this is that the cross-world counterfactual assumption
\begin{equation*}
  Y_{1,m}\indep M_0\mid W
\end{equation*}
does not hold in the above directed acyiclic graph.
- Technically, the
reason for this is that an intervention setting $A=1$ (necessary for
the definition of $Y_{1,m}$) induces a counterfactual variable
$Z_1$.
- Likewise, an intervention setting $A=0$ (necessary for the
definition of $M_0$) induces a counterfactual $Z_0$.
- The variables $Z_1$ and $Z_0$ are correlated because they share unmeasured common
causes.
- The variable $Z_1$ is correlated with $Y_{1,m}$, and the
variable $Z_0$ is correlated with $M_0$, because they are
counterfactual outcomes in the same hypothetical worlds.
- To see this in the definition of counterfactual from a causal structural model:
\begin{align*}
Y_{1,m} &= f_Y(W, 1, Z_1, m, U_Y), \text{ and }\\
M_0 &= f_M(W, 0, Z_0, U_M)\\
\end{align*}
are correlated even after adjusting for $W$ by virtue of $Z_1$ and $Z_0$ being correlated.

Intuitively:

- $Z$ is a confounder of the relation $M \rightarrow Y$, which requires adjustment
- But $Z$ is on the pathway $A\rightarrow Y$, which precludes adjustment

Note: CDEs are still identified in this setting. They can be identified and estimated similarly to a longitudinal data sructure with a two-time-point intervention.

## Interventional (in)direct effects

<!--
I think the distinction between fully conditional and not will be completely lost on people
-->

- Let $G_a$ denote a random draw from the distribution of $M_a \mid W$
- Define the counterfactual $Y_{1,G_0}$ as the counterfactual
  variable in a hypothetical world where $A$ is set $A=1$ and $M$ is
  set to $M=G_0$ with probability one.
- Define $Y_{0,G_0}$ and $Y_{1,G_1}$ similarly
- Then we can define:
\begin{equation*}
\E[Y_{1,G_1} - Y_{0,G_0}] = \underbrace{\E[Y_{\color{red}{1},\color{blue}{G_1}} -
    Y_{\color{red}{1},\color{blue}{G_0}}]}_{\text{interventional indirect effect}} +
    \underbrace{\E[Y_{\color{blue}{1},\color{red}{G_0}} -
    Y_{\color{blue}{0},\color{red}{G_0}}]}_{\text{interventional direct effect}}
\end{equation*}
<!--
 + Marginal PIDE: $\E(Y_{a, g_{M \mid a^{\star}, W}}) -
   \E(Y_{a^{\star}, g_{M \mid a^{\star}, W}})$
 + Marginal PIIE: $\E(Y_{a, g_{M \mid a, W}}) -
   \E(Y_{a, g_{M \mid a^{\star}, W}})$
 + Conditional PIDE: $\E(Y_{a, g_{M \mid Z, a^{\star}, W}}) -
   \E(Y_{a^{\star}, g_{M \mid Z, a^{\star}, W}})$
 + Conditional PIIE: $\E(Y_{a, g_{M \mid Z, a, W}}) -
   \E(Y_{a, g_{M \mid Z, a^{\star}, W}})$
 + Can you think of an example when you would want the conditional versions?
   Marginal versions?
-->

```{r , echo=FALSE, fig.cap="", fig.ext=if (knitr:::is_latex_output()) "pdf" else "png", out.width = "50%", results="asis"}
knitr::include_graphics(here::here("img", "graphic4b.png"))
```

### Identification assumptions:

- $A \indep Y_{a,m} \mid W$
- $M \indep Y_{a,m} \mid W, A, Z$
- $A \indep M_a \mid W$
- and positivity assumptions.

Under these assumptions, the population interventional direct and indirect effect is identified:
\begin{align*}
\E&(Y_{a, G_{a'}}) = \\
&\E\left[\color{Purple}{\E\left\{\color{Goldenrod}{\sum_z}\color{ForestGreen}{\E(Y \mid A=a, Z=z, M, W)} \color{Goldenrod}{\P(Z=z \mid A=a, W)}\mid A=a', W\right\}}\right]
\end{align*}

- Let's dissect this formula in R:

```{r, echo = TRUE, eval = TRUE, cache = TRUE}
n <- 1e7
w <- rnorm(n)
a <- rbinom(n, 1, 0.5)
z <- rbinom(n, 1, 0.5 + 0.2 * a)
m <- rnorm(n, w + a - z)
y <- rnorm(n, w - a + z + m)
```

- Let us compute $\E(Y_{1, G_0})$ (so that $a = 1$, and $a'=0$).
- Firs, fit a regression model for the outcome, and compute
\[\color{ForestGreen}{\E(Y \mid A=a, Z=z, M, W)}\]
for all values of $z$
```{r, echo = TRUE, eval = TRUE, cache = TRUE}
lm_y <- lm(y ~ m + a + z + w)
pred_a1z0 <- predict(lm_y, newdata = data.frame(m = m, a = 1, z = 0, w = w))
pred_a1z1 <- predict(lm_y, newdata = data.frame(m = m, a = 1, z = 1, w = w))
```
- Now we fit the true model for $Z\mid A, W$ and get the conditional probability that $Z=1$ fixing $A=1$
```{r, echo = TRUE, eval = TRUE, cache = TRUE}
prob_z <- lm(z ~ a)
pred_z <- predict(prob_z, newdata = data.frame(a = 1))
```
- Now we compute the following pseudo-outcome:
\[\color{Goldenrod}{\sum_z}\color{ForestGreen}{\E(Y \mid A=a, Z=z, M, W)} \color{Goldenrod}{\P(Z=z \mid A=a, w)}\]
```{r, echo = TRUE, eval = TRUE, cache = TRUE}
pseudo_out <- pred_a1z0 * (1 - pred_z) + pred_a1z1 * pred_z
```
- Now we regress this pseudo-outcome on $A,W$, and compute the predictions setting $A=0$, that is
\[\color{Purple}{\E\left\{\color{Goldenrod}{\sum_z}\color{ForestGreen}{\E(Y \mid A=a, Z=z, M, W)} \color{Goldenrod}{\P(Z=z \mid A=a, w)}\mid A=a', W\right\}}\]
```{r, echo = TRUE, eval = TRUE, cache = TRUE}
fit_pseudo <- lm(pseudo_out ~ a + w)
pred_pseudo <- predict(fit_pseudo, data.frame(a = 0, w = w))
```
- And finally, just average those predictions!
```{r, echo = TRUE, eval = TRUE, cache = TRUE}
## Mean(Y(1, G(0)))
mean(pred_pseudo)
```
- This was for $(a,a')=(1,0)$. Can do the same with $(a,a')=(1,1)$, and $(a,a')=(0,0)$ to obtain an effect decomposition

\begin{equation*}
\E[Y_{1,G_1} - Y_{0,G_0}] = \underbrace{\E[Y_{\color{red}{1},\color{blue}{G_1}} -
    Y_{\color{red}{1},\color{blue}{G_0}}]}_{\text{interventional indirect effect}} +
    \underbrace{\E[Y_{\color{blue}{1},\color{red}{G_0}} -
    Y_{\color{blue}{0},\color{red}{G_0}}]}_{\text{interventional direct effect}}
\end{equation*}

### Is this the estimand I want?

- Makes sense to intervene on $A$ but not directly on $M$.
- Goal is to understand a natural mechanism underlying an association or total
  effect.
- Okay with the assumptions!


## Estimand Summary
<!--
ID: Can we redo the below table fixing the G notation? Also, is it possible to fix the formatting? (currently not very amenable to a presentation I think)
-->
```{r , echo=FALSE, fig.cap="", fig.ext=if (knitr:::is_latex_output()) "pdf" else "png", out.width = "125%", results="asis"}
knitr::include_graphics(here::here("img", "table1.png"))
```
