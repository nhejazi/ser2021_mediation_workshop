<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 7 Estimating (in)direct effects with R packages | [SER 2021 Workshop] Causal Mediation: Modern Methods for Path Analysis</title>
<meta name="author" content="Iván Díaz, Nima Hejazi, Kara Rudolph">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.4.9003/tabs.js"></script><script src="libs/bs3compat-0.2.4.9003/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
</head>
<body>
<span class="math inline">
  \(\DeclareMathOperator{\expit}{expit}\)
  \(\DeclareMathOperator{\logit}{logit}\)
  \(\DeclareMathOperator*{\argmin}{\arg\!\min}\)
  \(\newcommand{\indep}{\perp\!\!\!\perp}\)
  \(\newcommand{\coloneqq}{\mathrel{=}}\)
  \(\newcommand{\R}{\mathbb{R}}\)
  \(\newcommand{\E}{\mathbb{E}}\)
  \(\newcommand{\M}{\mathcal{M}}\)
  \(\renewcommand{\P}{\mathbb{P}}\)
  \(\newcommand{\I}{\mathbb{I}}\)
  \(\newcommand{\1}{\mathbbm{1}}\)
  </span>
    <script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">[SER 2021 Workshop] Causal Mediation: Modern Methods for Path Analysis</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome to SER!</a></li>
<li><a class="" href="mediation.html"><span class="header-section-number">1</span> Preliminaries on causal mediation analysis</a></li>
<li><a class="" href="estimands.html"><span class="header-section-number">2</span> Path-specific casual mediation effect types</a></li>
<li><a class="" href="stochastic.html"><span class="header-section-number">3</span> Stochastic Direct and Indirect Effects</a></li>
<li><a class="" href="estimandirl.html"><span class="header-section-number">4</span> How to choose an estimand: Real world example</a></li>
<li><a class="" href="preliminaries-on-semiparametric-estimation.html"><span class="header-section-number">5</span> Preliminaries on semiparametric estimation</a></li>
<li><a class="" href="using-the-eif-to-construct-an-estimator-the-case-of-the-natural-direct-effect.html"><span class="header-section-number">6</span> Using the EIF to construct an estimator: the case of the natural direct effect</a></li>
<li><a class="active" href="estimating-indirect-effects-with-r-packages.html"><span class="header-section-number">7</span> Estimating (in)direct effects with R packages</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/nhejazi/ser2021_mediation_workshop">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="estimating-indirect-effects-with-r-packages" class="section level1">
<h1>
<span class="header-section-number">7</span> Estimating (in)direct effects with <code>R</code> packages<a class="anchor" aria-label="anchor" href="#estimating-indirect-effects-with-r-packages"><i class="fas fa-link"></i></a>
</h1>
<div id="medshift-stochastic-indirect-effects" class="section level2">
<h2>
<span class="header-section-number">7.1</span> <code>medshift</code>: Stochastic (in)direct effects<a class="anchor" aria-label="anchor" href="#medshift-stochastic-indirect-effects"><i class="fas fa-link"></i></a>
</h2>
<p>We are interested in assessing the population intervention direct effect and
the population intervention indirect effect, based on the effect decomposition
of the population intervention effect introduced in <span class="citation">Dı́az and Hejazi (<a href="references.html#ref-diaz2020causal" role="doc-biblioref">2020</a>)</span>.</p>
<p>To proceed, we’ll use as our running example a simple data set from an
observational study of the relationship between BMI and kids behavior,
distributed as part of the <a href="https://CRAN.R-project.org/package=mma"><code>mma</code> R package on
CRAN</a>. First, let’s load the packages
we’ll be using and set a seed; then, load this data set and take a quick look
at it</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># preliminaries</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tlverse.org/sl3">sl3</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nhejazi/medshift">medshift</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.r-project.org">mma</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">429153</span><span class="op">)</span>

<span class="co"># load and examine data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">weight_behavior</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">weight_behavior</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">weight_behavior</span><span class="op">)</span></code></pre></div>
<p>The documentation for the data set describes it as a “database obtained from the
Louisiana State University Health Sciences Center, New Orleans, by Dr. Richard
Scribner. He explored the relationship between BMI and kids behavior through a
survey at children, teachers and parents in Grenada in 2014. This data set
includes 691 observations and 15 variables.”</p>
<p>Unfortunately, the data set contains a few observations with missing values. As
these are unrelated to the object of our analysis, we’ll simply remove these for
the time being. Note that in a real data analysis, we might consider strategies
to fully make of the observed data, perhaps by imputing missing values. For now,
we simply remove the incomplete observations, resulting in a data set with fewer
observations but much the same structure as the original:</p>
<p>For the analysis of this observational data set, we focus on the effect of
participating in a sports team (<code>sports</code>) on the BMI of children (<code>bmi</code>), taking
several related covariates as mediators (<code>snack</code>, <code>exercises</code>, <code>overweigh</code>) and
all other collected covariates as potential confounders. Considering an NPSEM,
we separate the observed variables from the data set into their corresponding
nodes as follows</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">weight_behavior_complete</span><span class="op">$</span><span class="va">bmi</span>
<span class="va">A</span> <span class="op">&lt;-</span> <span class="va">weight_behavior_complete</span><span class="op">$</span><span class="va">sports</span>
<span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">weight_behavior_complete</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">snack</span>, <span class="va">exercises</span>, <span class="va">overweigh</span><span class="op">)</span>
<span class="va">W</span> <span class="op">&lt;-</span> <span class="va">weight_behavior_complete</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">age</span>, <span class="va">sex</span>, <span class="va">race</span>, <span class="va">numpeople</span>, <span class="va">car</span>, <span class="va">gotosch</span>, <span class="va">tvhours</span>, <span class="va">cmpthours</span>,
    <span class="va">cellhours</span>, <span class="va">sweat</span>
  <span class="op">)</span></code></pre></div>
<p>Finally, in our analysis, we consider an incremental propensity score
intervention (IPSI), as first proposed by <span class="citation">(<span class="citeproc-not-found" data-reference-id="kennedy2017nonparametric"><strong>???</strong></span>)</span>, wherein the
<em>odds of participating in a sports team</em> is modulated by some fixed amount
(<span class="math inline">\(0 \leq \delta \leq \infty\)</span>) for each individual. Such an intervention may be
interpreted as the effect of a school program that motivates children to
participate in sports teams. To exemplify our approach, we postulate a
motivational intervention that <em>triples the odds</em> of participating in a sports
team for each individual:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">delta_shift_ipsi</span> <span class="op">&lt;-</span> <span class="fl">3</span></code></pre></div>
<p>To easily incorporate ensemble machine learning into the estimation procedure,
we rely on the facilities provided in the <a href="https://tlverse.org/sl3"><code>sl3</code> R
package</a> <span class="citation">(<span class="citeproc-not-found" data-reference-id="coyle2020sl3"><strong>???</strong></span>)</span>. For a complete guide on using
the <code>sl3</code> R package, consider consulting <a href="https://tlverse.org/sl3" class="uri">https://tlverse.org/sl3</a>, or
<a href="https://tlverse.org" class="uri">https://tlverse.org</a> (and <a href="https://github.com/tlverse" class="uri">https://github.com/tlverse</a>) for the <code>tlverse</code>
ecosystem, of which <code>sl3</code> is a major part. We construct an ensemble learner
using a handful of popular machine learning algorithms below</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># SL learners used for continuous data (the nuisance parameter M)</span>
<span class="va">xgb_contin_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_xgboost.html">Lrnr_xgboost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>nrounds <span class="op">=</span> <span class="fl">50</span>, objective <span class="op">=</span> <span class="st">"reg:linear"</span><span class="op">)</span>
<span class="va">enet_contin_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glmnet.html">Lrnr_glmnet</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  alpha <span class="op">=</span> <span class="fl">0.5</span>, family <span class="op">=</span> <span class="st">"gaussian"</span>,
  nfolds <span class="op">=</span> <span class="fl">3</span>
<span class="op">)</span>
<span class="va">lasso_contin_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glmnet.html">Lrnr_glmnet</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  alpha <span class="op">=</span> <span class="fl">1</span>, family <span class="op">=</span> <span class="st">"gaussian"</span>,
  nfolds <span class="op">=</span> <span class="fl">3</span>
<span class="op">)</span>
<span class="va">fglm_contin_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glm_fast.html">Lrnr_glm_fast</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">gaussian</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">contin_lrnr_lib</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Stack.html">Stack</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  <span class="va">enet_contin_lrnr</span>, <span class="va">lasso_contin_lrnr</span>,
  <span class="va">fglm_contin_lrnr</span>, <span class="va">xgb_contin_lrnr</span>
<span class="op">)</span>
<span class="va">sl_contin_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learners <span class="op">=</span> <span class="va">contin_lrnr_lib</span>,
  metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># SL learners used for binary data (nuisance parameters G and E in this case)</span>
<span class="va">xgb_binary_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_xgboost.html">Lrnr_xgboost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>nrounds <span class="op">=</span> <span class="fl">50</span>, objective <span class="op">=</span> <span class="st">"reg:logistic"</span><span class="op">)</span>
<span class="va">enet_binary_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glmnet.html">Lrnr_glmnet</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  alpha <span class="op">=</span> <span class="fl">0.5</span>, family <span class="op">=</span> <span class="st">"binomial"</span>,
  nfolds <span class="op">=</span> <span class="fl">3</span>
<span class="op">)</span>
<span class="va">lasso_binary_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glmnet.html">Lrnr_glmnet</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  alpha <span class="op">=</span> <span class="fl">1</span>, family <span class="op">=</span> <span class="st">"binomial"</span>,
  nfolds <span class="op">=</span> <span class="fl">3</span>
<span class="op">)</span>
<span class="va">fglm_binary_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glm_fast.html">Lrnr_glm_fast</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">binary_lrnr_lib</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Stack.html">Stack</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  <span class="va">enet_binary_lrnr</span>, <span class="va">lasso_binary_lrnr</span>,
  <span class="va">fglm_binary_lrnr</span>, <span class="va">xgb_binary_lrnr</span>
<span class="op">)</span>
<span class="va">logistic_metalearner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span><span class="op">(</span>
  <span class="va">Lrnr_solnp</span>,
  <span class="va">metalearner_logistic_binomial</span>,
  <span class="va">loss_loglik_binomial</span>
<span class="op">)</span>
<span class="va">sl_binary_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learners <span class="op">=</span> <span class="va">binary_lrnr_lib</span>,
  metalearner <span class="op">=</span> <span class="va">logistic_metalearner</span>
<span class="op">)</span></code></pre></div>
<div id="decomposing-the-population-intervention-effect" class="section level3">
<h3>
<span class="header-section-number">7.1.1</span> Decomposing the population intervention effect<a class="anchor" aria-label="anchor" href="#decomposing-the-population-intervention-effect"><i class="fas fa-link"></i></a>
</h3>
<p>We may decompose the population intervention effect (PIE) in terms of a
<em>population intervention direct effect</em> (PIDE) and a <em>population
intervention indirect effect</em> (PIIE):
<span class="math display">\[\begin{equation*}
  \overbrace{\mathbb{E}\{Y(A_\delta, Z(A_\delta)) -
    Y(A_\delta, Z)\}}^{\text{PIIE}} +
    \overbrace{\mathbb{E}\{Y(A_\delta, Z) - Y(A, Z)\}}^{\text{PIDE}}.
\end{equation*}\]</span></p>
<p>This decomposition of the PIE as the sum of the population intervention direct
and indirect effects has an interpretation analogous to the corresponding
standard decomposition of the average treatment effect. In the sequel, we will
compute each of the components of the direct and indirect effects above using
appropriate estimators as follows</p>
<ul>
<li>For <span class="math inline">\(\mathbb{E}\{Y(A, Z)\}\)</span>, the sample mean <span class="math inline">\(\frac{1}{n}\sum_{i=1}^n Y_i\)</span> is
sufficient;</li>
<li>for <span class="math inline">\(\mathbb{E}\{Y(A_{\delta}, Z)\}\)</span>, an efficient one-step estimator for the
effect of a joint intervention altering the exposure mechanism but not the
mediation mechanism, as proposed in <span class="citation">Dı́az and Hejazi (<a href="references.html#ref-diaz2020causal" role="doc-biblioref">2020</a>)</span>; and,</li>
<li>for <span class="math inline">\(\mathbb{E}\{Y(A_{\delta}, Z_{A_{\delta}})\}\)</span>, an efficient one-step
estimator for the effect of a joint intervention altering both the exposure
and mediation mechanisms, as proposed in <span class="citation">(<span class="citeproc-not-found" data-reference-id="kennedy2017nonparametric"><strong>???</strong></span>)</span> and
implemented in the <a href="https://github.com/ehkennedy/npcausal"><code>npcausal</code> R
package</a>.</li>
</ul>
</div>
<div id="estimating-the-effect-decomposition-term" class="section level3">
<h3>
<span class="header-section-number">7.1.2</span> Estimating the effect decomposition term<a class="anchor" aria-label="anchor" href="#estimating-the-effect-decomposition-term"><i class="fas fa-link"></i></a>
</h3>
<p>As given in <span class="citation">Dı́az and Hejazi (<a href="references.html#ref-diaz2020causal" role="doc-biblioref">2020</a>)</span>, the statistical functional identifying the
decomposition term that appears in both the PIDE and PIIE
<span class="math inline">\(\mathbb{E}\{Y(A_{\delta}, Z)\}\)</span>, which corresponds to altering the exposure
mechanism while keeping the mediation mechanism fixed, is
<span class="math display">\[\begin{equation*}
  \theta_0(\delta) = \int m_0(a, z, w) g_{0,\delta}(a \mid w) p_0(z, w)
    d\nu(a, z, w),
\end{equation*}\]</span>
for which a one-step estimator is available. The corresponding <em>efficient
influence function</em> (EIF) with respect to the nonparametric model <span class="math inline">\(\mathcal{M}\)</span>
is <span class="math inline">\(D_{\eta,\delta}(o) = D^Y_{\eta,\delta}(o) + D^A_{\eta,\delta}(o) + D^{Z,W}_{\eta,\delta}(o) - \theta(\delta)\)</span>. The
one-step estimator may be computed using the EIF estimating equation, making use
of cross-fitting <span class="citation">(<span class="citeproc-not-found" data-reference-id="zheng2011cross"><strong>???</strong></span>; <span class="citeproc-not-found" data-reference-id="chernozhukov2018double"><strong>???</strong></span>)</span> to circumvent any
need for entropy conditions (i.e., Donsker class restrictions). The resultant
estimator is
<span class="math display">\[\begin{equation*}
  \hat{\theta}(\delta) = \frac{1}{n} \sum_{i = 1}^n D_{\hat{\eta}_{j(i)},
  \delta}(O_i) = \frac{1}{n} \sum_{i = 1}^n \left\{ D^Y_{\hat{\eta}_{j(i)},
  \delta}(O_i) + D^A_{\hat{\eta}_{j(i)}, \delta}(O_i) +
  D^{Z,W}_{\hat{\eta}_{j(i)}, \delta}(O_i) \right\},
\end{equation*}\]</span>
which is implemented in the <code>medshift</code> R package. We make use of that
implementation to estimate <span class="math inline">\(\mathbb{E}\{Y(A_{\delta}, Z)\}\)</span> via its one-step
estimator <span class="math inline">\(\hat{\theta}(\delta)\)</span> below</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># let's compute the parameter where A (but not Z) are shifted</span>
<span class="va">theta_eff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/medshift/man/medshift.html">medshift</a></span><span class="op">(</span>
  W <span class="op">=</span> <span class="va">W</span>, A <span class="op">=</span> <span class="va">A</span>, Z <span class="op">=</span> <span class="va">Z</span>, Y <span class="op">=</span> <span class="va">Y</span>,
  delta <span class="op">=</span> <span class="va">delta_shift_ipsi</span>,
  g_learners <span class="op">=</span> <span class="va">sl_binary_lrnr</span>,
  e_learners <span class="op">=</span> <span class="va">sl_binary_lrnr</span>,
  m_learners <span class="op">=</span> <span class="va">sl_contin_lrnr</span>,
  phi_learners <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_hal9001.html">Lrnr_hal9001</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,
  estimator <span class="op">=</span> <span class="st">"onestep"</span>,
  estimator_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>cv_folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">theta_eff</span><span class="op">)</span></code></pre></div>
</div>
<div id="estimating-the-direct-effect" class="section level3">
<h3>
<span class="header-section-number">7.1.3</span> Estimating the direct effect<a class="anchor" aria-label="anchor" href="#estimating-the-direct-effect"><i class="fas fa-link"></i></a>
</h3>
<p>Recall that, based on the decomposition outlined previously, the population
intervention direct effect may be denoted <span class="math inline">\(\beta_{\text{PIDE}}(\delta) = \theta_0(\delta) - \mathbb{E}Y\)</span>. Thus, an estimator of the PIDE,
<span class="math inline">\(\hat{\beta}_{\text{PIDE}}(\delta)\)</span> may be expressed as a composition of
estimators of its constituent parameters:
<span class="math display">\[\begin{equation*}
  \hat{\beta}_{\text{PIDE}}({\delta}) = \hat{\theta}(\delta) -
  \frac{1}{n} \sum_{i = 1}^n Y_i.
\end{equation*}\]</span></p>
<p>Based on the above, we may construct an estimator of the PIDE using quantities
already computed. The convenience function below applies the simple delta method
required in the case of a linear contrast between the two constituent
parameters:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># convenience function to compute inference via delta method: EY1 - EY0</span>
<span class="va">linear_contrast</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">eifs</span>, <span class="va">ci_level</span> <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># bounds for confidence interval</span>
  <span class="va">ci_norm_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span>p <span class="op">=</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">ci_level</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
  <span class="va">param_est</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="va">params</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
  <span class="va">eif</span> <span class="op">&lt;-</span> <span class="va">eifs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="va">eifs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
  <span class="va">se_eif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">eif</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">eif</span><span class="op">)</span><span class="op">)</span>
  <span class="va">param_ci</span> <span class="op">&lt;-</span> <span class="va">param_est</span> <span class="op">+</span> <span class="va">ci_norm_bounds</span> <span class="op">*</span> <span class="va">se_eif</span>
  <span class="co"># parameter and inference</span>
  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">param_ci</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">param_est</span>, <span class="va">param_ci</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lwr_ci"</span>, <span class="st">"param_est"</span>, <span class="st">"upr_ci"</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>With the above convenience function in hand, we’ll construct or extract the
necessary components from existing objects and simply apply the function:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># parameter estimates and EIFs for components of direct effect</span>
<span class="va">EY</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>
<span class="va">eif_EY</span> <span class="op">&lt;-</span> <span class="va">Y</span> <span class="op">-</span> <span class="va">EY</span>
<span class="va">params_de</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">theta_eff</span><span class="op">$</span><span class="va">theta</span>, <span class="va">EY</span><span class="op">)</span>
<span class="va">eifs_de</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">theta_eff</span><span class="op">$</span><span class="va">eif</span>, <span class="va">eif_EY</span><span class="op">)</span>

<span class="co"># direct effect = EY - estimated quantity</span>
<span class="va">de_est</span> <span class="op">&lt;-</span> <span class="fu">linear_contrast</span><span class="op">(</span><span class="va">params_de</span>, <span class="va">eifs_de</span><span class="op">)</span>
<span class="va">de_est</span></code></pre></div>
</div>
</div>
<div id="medoutcon-naturalinterventional-effects" class="section level2">
<h2>
<span class="header-section-number">7.2</span> <code>medoutcon</code>: Natural/Interventional Effects<a class="anchor" aria-label="anchor" href="#medoutcon-naturalinterventional-effects"><i class="fas fa-link"></i></a>
</h2>
<p>An exposure of interest often affects an outcome directly, or indirectly by the
mediation of some intermediate variables. Identifying and quantifying the
mechanisms underlying causal effects is an increasingly popular endeavor in
public health, medicine, and the social sciences, as knowledge of such
mechanisms can improve understanding of both <em>why and how</em> treatments can be
effective. Such mechanistic knowledge may be arguably even more important in
cases where treatments result in unanticipated ineffective or even harmful
effects.</p>
<p>Traditional techniques for mediation analysis fare poorly in the face of
intermediate confounding. Classical parameters like the natural (in)direct
effects face a lack of identifiability in cases where mediator-outcome (i.e.,
intermediate) confounders affected by exposure complicate the relationship
between the exposure, mediators, and outcome. <span class="citation">(<span class="citeproc-not-found" data-reference-id="diaz2020nonparametric"><strong>???</strong></span>)</span> provide a
theoretical and computational study of the properties of newly developed
interventional (in)direct effect estimands within the non-parametric statistical
model. Among their contributions, <span class="citation">(<span class="citeproc-not-found" data-reference-id="diaz2020nonparametric"><strong>???</strong></span>)</span></p>
<ul>
<li>derive the efficient influence function (EIF), an key object in
semiparametric efficiency theory;</li>
<li>use the EIF to develop two asymptotically optimal, non-parametric estimators,
each of which is capable of leveraging machine learning for the estimation of
nuisance parameters; and</li>
<li>present theoretical conditions under which their proposed estimators are
consistent, multiply robust, and efficient.</li>
</ul>
<div id="problem-setup-and-notation" class="section level3">
<h3>
<span class="header-section-number">7.2.1</span> Problem Setup and Notation<a class="anchor" aria-label="anchor" href="#problem-setup-and-notation"><i class="fas fa-link"></i></a>
</h3>
<p>The problem addressed by the work of <span class="citation">(<span class="citeproc-not-found" data-reference-id="diaz2020nonparametric"><strong>???</strong></span>)</span> may be represented
by the following nonparametric structural equation model (NPSEM):
<span class="math display">\[\begin{align*}
  W &amp;= f_W(U_W); A = f_A(W, U_A); Z=f_Z(W, A, U_Z);\\ \nonumber
  M &amp;= f_M(W, A, Z, U_M); Y = f_Y(W, A, Z, M, U_Y).
\end{align*}\]</span>
In the NPSEM, <span class="math inline">\(W\)</span> denotes a vector of observed pre-treatment covariates, <span class="math inline">\(A\)</span>
denotes a categorical treatment variable, <span class="math inline">\(Z\)</span> denotes an intermediate confounder
affected by treatment, <span class="math inline">\(M\)</span> denotes a (possibly multivariate) mediator, and <span class="math inline">\(Y\)</span>
denotes a continuous or binary outcome. The vector of exogenous factors
<span class="math inline">\(U=(U_W,U_A,U_Z,U_M,U_Y)\)</span>, and the functions <span class="math inline">\(f\)</span>, are assumed deterministic but
unknown. Importantly, the NPSEM encodes a time-ordering between these variables
and allows the evaluation of counterfactual quantities defined by intervening on
a set of nodes of the NPSEM. The observed data unit can be represented by the
random variable <span class="math inline">\(O = (W, A, Z, M, Y)\)</span>; we consider access to <span class="math inline">\(O_1, \ldots, O_n\)</span>,
a sample of <span class="math inline">\(n\)</span> i.i.d. observations of <span class="math inline">\(O\)</span>.</p>
<p><span class="citation">(<span class="citeproc-not-found" data-reference-id="diaz2020nonparametric"><strong>???</strong></span>)</span> additionally define the following parameterizations,
familiarity with which will be useful for using the <a href="https://github.com/nhejazi/medoutcon"><code>medoutcon</code> <code>R</code>
package</a>. In particular, these authors
define <span class="math inline">\(g(a \mid w)\)</span> as the probability mass function of <span class="math inline">\(A = a\)</span> conditional on
<span class="math inline">\(W = w\)</span> and use <span class="math inline">\(h(a \mid m, w)\)</span> to denote the probability mass function of <span class="math inline">\(A = a\)</span> conditional on <span class="math inline">\((M, W) = (m, w)\)</span>. Further, <span class="citation">(<span class="citeproc-not-found" data-reference-id="diaz2020nonparametric"><strong>???</strong></span>)</span> use
<span class="math inline">\(b(a, z, m, w)\)</span> to denote the outcome regression function <span class="math inline">\(\mathbb{E}(Y \mid A = a, Z = z, M = m, W = w)\)</span>, as well as <span class="math inline">\(q(z \mid a,w)\)</span> and <span class="math inline">\(r(z \mid a, m, w)\)</span>
to denote the corresponding conditional densities of <span class="math inline">\(Z\)</span>.</p>
</div>
<div id="interventional-indirect-effects-1" class="section level3">
<h3>
<span class="header-section-number">7.2.2</span> Interventional (In)Direct Effects<a class="anchor" aria-label="anchor" href="#interventional-indirect-effects-1"><i class="fas fa-link"></i></a>
</h3>
<p><span class="citation">(<span class="citeproc-not-found" data-reference-id="diaz2020nonparametric"><strong>???</strong></span>)</span> define the <em>total effect</em> of <span class="math inline">\(A\)</span> on <span class="math inline">\(Y\)</span> in terms of a
contrast between two user-supplied values <span class="math inline">\(a', a^{\star} \in \mathcal{A}\)</span>.
Examination of the NPSEM reveals that there are four paths involved in this
effect, namely <span class="math inline">\(A \rightarrow Y\)</span>, <span class="math inline">\(A \rightarrow M \rightarrow Y\)</span>, <span class="math inline">\(A \rightarrow Z \rightarrow Y\)</span>, and <span class="math inline">\(A \rightarrow Z \rightarrow M \rightarrow Y\)</span>.
Mediation analysis has classically considered the <em>natural direct effect</em> (NDE)
and the <em>natural indirect effect</em> (NIE), which are defined as
<span class="math inline">\(\mathbb{E}_c(Y_{a', M_{a^{\star}}} - Y_{a^{\star}, M_{a^{\star}}})\)</span> and
<span class="math inline">\(\mathbb{E}_c(Y_{a',M_{a'}} - Y_{a',M_{a^{\star}}})\)</span>, respectively. The natural
direct effect measures the effect through paths <em>not</em> involving the mediator
(<span class="math inline">\(A \rightarrow Y\)</span> and <span class="math inline">\(A \rightarrow Z \rightarrow Y\)</span>), whereas the natural
indirect effect measures the effect through paths involving the mediator
(<span class="math inline">\(A \rightarrow M \rightarrow Y\)</span> and <span class="math inline">\(A \rightarrow Z \rightarrow M \rightarrow Y\)</span>). As the sum of the natural direct and indirect effects equals the average
treatment effect <span class="math inline">\(\mathbb{E}_c(Y_1-Y_0)\)</span>, this effect decomposition is
appealing. Unfortunately, the natural direct and indirect effects are
not generally identified in the presence of an intermediate confounder affected
by treatment.</p>
<p>To circumvent this issue, <span class="citation">(<span class="citeproc-not-found" data-reference-id="diaz2020nonparametric"><strong>???</strong></span>)</span> define the direct and indirect
effects using stochastic interventions on the mediator, following a strategy
previously outlined by <span class="citation">(<span class="citeproc-not-found" data-reference-id="vanderweele2014effect"><strong>???</strong></span>)</span> and <span class="citation">(<span class="citeproc-not-found" data-reference-id="rudolph2017robust"><strong>???</strong></span>)</span>, among
others. Let <span class="math inline">\(G_a\)</span> denote a random draw from the conditional distribution of
<span class="math inline">\(M_a\)</span> conditional on <span class="math inline">\(W\)</span>. Consider the effect of <span class="math inline">\(A\)</span> on <span class="math inline">\(Y\)</span> defined as the
difference in expected outcome in hypothetical worlds in which <span class="math inline">\((A,M) = (a', G_{a'})\)</span> versus <span class="math inline">\((A,M) = (a^{\star}, G_{a^{\star}})\)</span> with probability one, which
may be decomposed into direct and indirect effects as follows
<span class="math display">\[\begin{equation*}
\mathbb{E}_c(Y_{a', G_{a'}} - Y_{a^{\star}, G_{a^{\star}}}) =
  \underbrace{\mathbb{E}_c(Y_{a', G_{a'}} - Y_{a',
    G_{a^{\star}}})}_{\text{Indirect effect (through $M$)}} +
  \underbrace{\mathbb{E}_c(Y_{a', G_{a^{\star}}} - Y_{a^{\star},
      G_{a^{\star}}})}_{\text{Direct effect (not through $M$)}}.
\end{equation*}\]</span>
Like the natural direct effect, this interventional direct effect measures the
effects through paths not involving the mediator. Likewise, the interventional
indirect effect measures the effect through paths involving the mediator. Note,
however, that natural and interventional mediation effects have different
interpretations. That is, the interventional indirect effect measures the effect
of fixing the exposure at <span class="math inline">\(a'\)</span> while setting the mediator to a random draw
<span class="math inline">\(G_{a^{\star}}\)</span> from those with exposure <span class="math inline">\(a'\)</span> versus a random draw <span class="math inline">\(G_{a'}\)</span> from
those with exposure <span class="math inline">\(a^{\star}\)</span>, given covariates <span class="math inline">\(W\)</span>. As is clear from the
effect decomposition, the term <span class="math inline">\(\theta_c = \mathbb{E}_c(Y_{a', G_{a^{\star}}})\)</span>
is required for estimation of both the interventional direct and indirect
effects; thus, <span class="citation">(<span class="citeproc-not-found" data-reference-id="diaz2020nonparametric"><strong>???</strong></span>)</span> focus on estimation of this quantity.
Importantly, it has been shown that <span class="math inline">\(\theta_c\)</span> is identified by the statistical
functional
<span class="math display">\[\begin{equation*}
  \theta = \int b(a', z, m, w) q(z \mid a', w) p(m \mid a^{\star}, w)
    p(w) d\nu(w,z,m)
\end{equation*}\]</span>
under a set of standard identifiability conditions <span class="citation">(<span class="citeproc-not-found" data-reference-id="vanderweele2014effect"><strong>???</strong></span>)</span>,
which are further reviewed in <span class="citation">(<span class="citeproc-not-found" data-reference-id="diaz2020nonparametric"><strong>???</strong></span>)</span>.</p>
</div>
<div id="efficient-estimation" class="section level3">
<h3>
<span class="header-section-number">7.2.3</span> Efficient Estimation<a class="anchor" aria-label="anchor" href="#efficient-estimation"><i class="fas fa-link"></i></a>
</h3>
<p><span class="citation">(<span class="citeproc-not-found" data-reference-id="diaz2020nonparametric"><strong>???</strong></span>)</span> define two efficient estimators of their interventional
(in)direct effects. These are based on the one-step estimation and targeted
minimum loss (TML) estimation frameworks, respectively. Briefly, both estimation
strategies proceed in two stages, starting by first constructing initial
estimates of the nuisance parameters present in the EIF, then proceeding to
apply distinct bias-correction strategies in their second stages. Both
estimation strategies require an assumption about the behavior of initial
estimators of the nuisance parameters (specifically, that these lie in a Donsker
class); however, the need for such an assumption may be avoided by making use of
cross-validation in the fitting fo initial estimators. The <code>medoutcon</code> <code>R</code>
package requires the use of cross-validation in the construction of these
initial estimates, resulting in cross-fitted one-step and and cross-validated
TML estimators <span class="citation">(<span class="citeproc-not-found" data-reference-id="klaassen1987consistent"><strong>???</strong></span>; <span class="citeproc-not-found" data-reference-id="zheng2011cross"><strong>???</strong></span>; <span class="citeproc-not-found" data-reference-id="chernozhukov2018double"><strong>???</strong></span>)</span>.</p>
<p>The one-step estimator <span class="math inline">\(\hat{\theta}_{\text{os}}\)</span> is constructed by adding the
empirical mean of the EIF (evaluated at initial estimates of the nuisance
parameters) to the substitution estimator. By constrast, the TML estimator
<span class="math inline">\(\hat{\theta}_{\text{tmle}}\)</span> updates the components of the substitution
estimator via logistic tilting models formulated to ensure that relevant score
equations appearing in the EIF are (approximately) solved. While the estimators
are asymptotically equivalent, TML estimators have been shown to exhibit
superior finite-sample performance, making them potentially more reliable than
one-step estimators. For the exact form of the EIF as well as those of the
one-step and TML estimators, consult <span class="citation">(<span class="citeproc-not-found" data-reference-id="diaz2020nonparametric"><strong>???</strong></span>)</span>.</p>
</div>
<div id="data-analysis-example" class="section level3">
<h3>
<span class="header-section-number">7.2.4</span> Data Analysis Example<a class="anchor" aria-label="anchor" href="#data-analysis-example"><i class="fas fa-link"></i></a>
</h3>
<div id="setting-up-the-data-example" class="section level4">
<h4>
<span class="header-section-number">7.2.4.1</span> Setting up the data example<a class="anchor" aria-label="anchor" href="#setting-up-the-data-example"><i class="fas fa-link"></i></a>
</h4>
<p>Now, we’ll take a look at how to estimate the interventional direct and indirect
effects using a simulated data example. <span class="citation">(<span class="citeproc-not-found" data-reference-id="diaz2020nonparametric"><strong>???</strong></span>)</span> illustrate the
use of their estimators of these effects in an application in which they seek to
elucidate the mechanisms behind the unintended harmful effects that a housing
intervention had on adolescent girls’ risk behavior.</p>
<p>First, let’s load a few required packages and set a seed for our simulation.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nhejazi/medoutcon">medoutcon</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tlverse.org/sl3">sl3</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">75681</span><span class="op">)</span>
<span class="va">n_obs</span> <span class="op">&lt;-</span> <span class="fl">500</span></code></pre></div>
<p>Next, we’ll generate a very simple simulated dataset. The function
<code>make_example_data</code>, defined below, generates three binary baseline covariates
<span class="math inline">\(W = (W_1, W_2, W_3)\)</span>, a binary exposure variable <span class="math inline">\(A\)</span>, a single binary mediateor
<span class="math inline">\(M\)</span> an intermediate confounder <span class="math inline">\(Z\)</span> that affects the mediator <span class="math inline">\(M\)</span> and is itself
affected by the exposure <span class="math inline">\(A\)</span>, and, finally, a binary outcome <span class="math inline">\(Y\)</span> that is a
function of <span class="math inline">\((W, A, Z, M)\)</span>.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># produces a simple data set based on ca causal model with mediation</span>
<span class="va">make_example_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_obs</span> <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">{</span>
  <span class="co">## baseline covariates</span>
  <span class="va">w_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span>
  <span class="va">w_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>
  <span class="va">w_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="fl">0.2</span> <span class="op">+</span> <span class="op">(</span><span class="va">w_1</span> <span class="op">+</span> <span class="va">w_2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
  <span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">w_1</span>, <span class="va">w_2</span>, <span class="va">w_3</span><span class="op">)</span>
  <span class="va">w_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"W"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>

  <span class="co">## exposure</span>
  <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

  <span class="co">## mediator-outcome confounder affected by treatment</span>
  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">w</span> <span class="op">-</span> <span class="va">a</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span>

  <span class="co">## mediator -- could be multivariate</span>
  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op">*</span> <span class="va">w</span><span class="op">[</span>, <span class="op">-</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="va">a</span> <span class="op">-</span> <span class="va">z</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="va">m_names</span> <span class="op">&lt;-</span> <span class="st">"M"</span>

  <span class="co">## outcome</span>
  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op">-</span> <span class="va">z</span> <span class="op">+</span> <span class="va">a</span> <span class="op">+</span> <span class="va">m</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

  <span class="co">## construct output</span>
  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>w <span class="op">=</span> <span class="va">w</span>, a <span class="op">=</span> <span class="va">a</span>, z <span class="op">=</span> <span class="va">z</span>, m <span class="op">=</span> <span class="va">m</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">w_names</span>, <span class="st">"A"</span>, <span class="st">"Z"</span>, <span class="va">m_names</span>, <span class="st">"Y"</span><span class="op">)</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># set seed and simulate example data</span>
<span class="va">example_data</span> <span class="op">&lt;-</span> <span class="fu">make_example_data</span><span class="op">(</span><span class="va">n_obs</span><span class="op">)</span>
<span class="va">w_names</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_subset.html">str_subset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">example_data</span><span class="op">)</span>, <span class="st">"W"</span><span class="op">)</span>
<span class="va">m_names</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_subset.html">str_subset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">example_data</span><span class="op">)</span>, <span class="st">"M"</span><span class="op">)</span></code></pre></div>
<p>Now, let’s take a quick look at our simulated data:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># quick look at the data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">example_data</span><span class="op">)</span></code></pre></div>
<p>As noted above, all covariates in our dataset are binary; however, note that
this need not be the case for using our methodology — in particular, the only
current limitation is that the intermediate confounder <span class="math inline">\(Z\)</span> must be binary when
using our implemented TML estimator of the (in)direct effects.</p>
<p>Using this dataset, we’ll proceed to estimate the interventional (in)direct
effects. In order to do so, we’ll need to estimate several nuisance parameters,
including the exposure mechanism <span class="math inline">\(g(A \mid W)\)</span>, a re-parameterized exposure
mechanism that conditions on the mediators <span class="math inline">\(h(A \mid M, W)\)</span>, the outcome
mechanism <span class="math inline">\(b(Y \mid M, Z, A, W)\)</span>, and two variants of the intermediate
confounding mechanism <span class="math inline">\(q(Z \mid A, W)\)</span> and <span class="math inline">\(r(Z \mid M, A, W)\)</span>. In order to
estimate each of these nuisance parameters flexibly, we’ll rely on data adaptive
regression strategies in order to avoid the potential for (parametric) model
misspecification.</p>
</div>
<div id="ensemble-learning-of-nuisance-functions" class="section level4">
<h4>
<span class="header-section-number">7.2.4.2</span> Ensemble learning of nuisance functions<a class="anchor" aria-label="anchor" href="#ensemble-learning-of-nuisance-functions"><i class="fas fa-link"></i></a>
</h4>
<p>As we’d like to rely on flexible, data adaptive regression strategies for
estimating each of the nuisance parameters <span class="math inline">\((g, h, b, q, r)\)</span>, we require a
method for choosing among or combining the wide variety of available regression
strategies. For this, we recommend the use of the Super Learner algorithm for
ensemble machine learning <span class="citation">(van der Laan, Polley, and Hubbard <a href="references.html#ref-vdl2007super" role="doc-biblioref">2007</a>)</span>. The recently developed <a href="https://tlverse.org/sl3"><code>sl3</code> R
package</a> <span class="citation">(<span class="citeproc-not-found" data-reference-id="coyle2020sl3"><strong>???</strong></span>)</span> provides a unified interface
for deploying a wide variety of machine learning algorithms (simply called
<em>learners</em> in the <code>sl3</code> nomenclature) as well as for constructing Super Learner
ensemble models of such learners. For a complete guide on using the <code>sl3</code> R
package, consider consulting <a href="https://tlverse.org/sl3" class="uri">https://tlverse.org/sl3</a>, or <a href="https://tlverse.org" class="uri">https://tlverse.org</a>
(and <a href="https://github.com/tlverse" class="uri">https://github.com/tlverse</a>) for the <code>tlverse</code> ecosystem, of which <code>sl3</code> is
an integral part.</p>
<p>To construct an ensemble learner using a handful of popular machine learning
algorithms, we’ll first instantiate variants of learners from the appropriate
classes for each algorithm, and then create a Super Learner ensemble via the
<code>Lrnr_sl</code> class. Below, we demonstrate the construction of an ensemble learner
based on a modeling library including an intercept model, a main-terms GLM,
<span class="math inline">\(\ell_1\)</span>-penalized Lasso regression, an elastic net regression that equally
weights the <span class="math inline">\(\ell_1\)</span> and <span class="math inline">\(\ell_2\)</span> penalties, random forests (<code>ranger</code>), and the
highly adaptive lasso (HAL):</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># instantiate learners</span>
<span class="va">mean_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_mean.html">Lrnr_mean</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">fglm_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glm_fast.html">Lrnr_glm_fast</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">lasso_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glmnet.html">Lrnr_glmnet</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, nfolds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="va">enet_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glmnet.html">Lrnr_glmnet</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, nfolds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="va">rf_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_ranger.html">Lrnr_ranger</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>num.trees <span class="op">=</span> <span class="fl">200</span><span class="op">)</span>

<span class="co"># for HAL, use linear probability formulation, with bounding in unit interval</span>
<span class="va">hal_gaussian_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_hal9001.html">Lrnr_hal9001</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  family <span class="op">=</span> <span class="st">"gaussian"</span>,
  fit_control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    max_degree <span class="op">=</span> <span class="fl">3</span>,
    n_folds <span class="op">=</span> <span class="fl">3</span>,
    use_min <span class="op">=</span> <span class="cn">TRUE</span>,
    type.measure <span class="op">=</span> <span class="st">"mse"</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="va">bound_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_bound.html">Lrnr_bound</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>bound <span class="op">=</span> <span class="fl">1e-6</span><span class="op">)</span>
<span class="va">hal_bounded_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Pipeline.html">Pipeline</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">hal_gaussian_lrnr</span>, <span class="va">bound_lrnr</span><span class="op">)</span>

<span class="co"># create learner library and instantiate super learner ensemble</span>
<span class="va">lrnr_lib</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Stack.html">Stack</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  <span class="va">mean_lrnr</span>, <span class="va">fglm_lrnr</span>, <span class="va">enet_lrnr</span>, <span class="va">lasso_lrnr</span>,
  <span class="va">rf_lrnr</span>, <span class="va">hal_bounded_lrnr</span>
<span class="op">)</span>
<span class="va">sl_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>learners <span class="op">=</span> <span class="va">lrnr_lib</span>, metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>While we recommend the use of a Super Learner ensemble model like the one
constructed above in practice, such a library will be too computationally
intensive for our examples. To reduce computation time, we construct a simpler
library, using only a subset of the above learning algorithms:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create simpler learner library and instantiate super learner ensemble</span>
<span class="va">lrnr_lib</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Stack.html">Stack</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">mean_lrnr</span>, <span class="va">fglm_lrnr</span>, <span class="va">lasso_lrnr</span>, <span class="va">rf_lrnr</span><span class="op">)</span>
<span class="va">sl_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>learners <span class="op">=</span> <span class="va">lrnr_lib</span>, metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Having set up our ensemble learner, we’re now ready to estimate each of the
interventional effects using the efficient estimators exposed in the <code>medoutcon</code>
package.</p>
</div>
<div id="estimating-the-direct-effect-1" class="section level4">
<h4>
<span class="header-section-number">7.2.4.3</span> Estimating the direct effect<a class="anchor" aria-label="anchor" href="#estimating-the-direct-effect-1"><i class="fas fa-link"></i></a>
</h4>
<p>We’re now ready to estimate the interventional direct effect. This direct effect
is computed as a contrast between the interventions <span class="math inline">\((a' = 1, a^{\star} = 0)\)</span>
and <span class="math inline">\((a' = 0, a^{\star} = 0)\)</span>. In particular, our efficient estimators of the
interventional direct effect proceed by constructing estimators
<span class="math inline">\(\hat{\theta}(a' = 1, a^{\star} = 0)\)</span> and <span class="math inline">\(\hat{\theta}(a' = 0, a^{\star} = 0)\)</span>.
Then, an efficient estimator of the direct effect is available by application
of the delta method, that is, <span class="math inline">\(\hat{\theta}^{\text{DE}} = \hat{\theta}(a' = 1, a^{\star} = 0) - \hat{\theta}(a' = 0, a^{\star} = 0)\)</span>.
Applying the same principle to the EIF estimates, one can derive variance
estimates and construct asymptotically correct Wald-style confidence intervals
for <span class="math inline">\(\hat{\theta}^{\text{DE}}\)</span>.</p>
<p>The <code>medoutcon</code> package makes the estimation task quite simple, as only a single
call to the eponymous <code>medoutcon</code> function is required. As demonstrated below,
we need only feed in each component of the observed data <span class="math inline">\(O = (W, A, Z, M, Y)\)</span>
(of which <span class="math inline">\(W\)</span> and <span class="math inline">\(M\)</span> can be multivariate), specify the effect type, and the
estimator. Additionally, for each nuisance parameter we may specify a separate
regression function — in the examples below, we use the simpler Super Learner
ensemble constructed above for fitting each nuisance function, but this need not
be the case (i.e., different estimators may be used for each nuisance function).</p>
<p>First, we examine the one-step estimator of the interventional direct effect.
Recall that the one-step estimator is constructed by adding the mean of the EIF
(evaluated at initial estimates of the nuisance parameters) to the substitution
estimator. As noted above, this is done separately for each of the two contrasts
<span class="math inline">\((a' = 0, a^{\star} = 0)\)</span> and <span class="math inline">\((a' = 1, a^{\star} = 0)\)</span>. Thus, the one-step
estimator of this direct effect is constructed by application of the delta
method to each of the one-step estimators (and EIFs) for these contrasts.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># compute one-step estimate of the interventional direct effect</span>
<span class="va">os_de</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/medoutcon/man/medoutcon.html">medoutcon</a></span><span class="op">(</span>
  W <span class="op">=</span> <span class="va">example_data</span><span class="op">[</span>, <span class="va">..w_names</span><span class="op">]</span>,
  A <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">A</span>,
  Z <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">Z</span>,
  M <span class="op">=</span> <span class="va">example_data</span><span class="op">[</span>, <span class="va">..m_names</span><span class="op">]</span>,
  Y <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">Y</span>,
  g_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  h_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  b_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  q_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  r_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  effect <span class="op">=</span> <span class="st">"direct"</span>,
  estimator <span class="op">=</span> <span class="st">"onestep"</span>,
  estimator_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>cv_folds <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">os_de</span><span class="op">)</span></code></pre></div>
<p>Next, let’s compare the one-step estimate to the TML estimate. Analogous to the
case of the one-step estimator, the TML estimator can be evaluated via a single
call to the <code>medoutcon</code> function:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># compute targeted minimum loss estimate of the interventional direct effect</span>
<span class="va">tmle_de</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/medoutcon/man/medoutcon.html">medoutcon</a></span><span class="op">(</span>
  W <span class="op">=</span> <span class="va">example_data</span><span class="op">[</span>, <span class="va">..w_names</span><span class="op">]</span>,
  A <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">A</span>,
  Z <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">Z</span>,
  M <span class="op">=</span> <span class="va">example_data</span><span class="op">[</span>, <span class="va">..m_names</span><span class="op">]</span>,
  Y <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">Y</span>,
  g_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  h_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  b_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  q_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  r_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  effect <span class="op">=</span> <span class="st">"direct"</span>,
  estimator <span class="op">=</span> <span class="st">"tmle"</span>,
  estimator_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>cv_folds <span class="op">=</span> <span class="fl">2</span>, max_iter <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">tmle_de</span><span class="op">)</span></code></pre></div>
<p>Here, we recall that the TML
estimator generally exhibits better finite-sample performance than the one-step
estimator <span class="citation">(van der Laan and Rose <a href="references.html#ref-vdl2011targeted" role="doc-biblioref">2011</a>, <a href="references.html#ref-vdl2018targeted" role="doc-biblioref">2018</a>)</span>, so the TML estimate is likely to
be more reliable in modest (realistic) sample sizes.</p>
</div>
<div id="estimating-the-indirect-effect" class="section level4">
<h4>
<span class="header-section-number">7.2.4.4</span> Estimating the indirect effect<a class="anchor" aria-label="anchor" href="#estimating-the-indirect-effect"><i class="fas fa-link"></i></a>
</h4>
<p>Estimation of the interventional indirect effect proceeds similarly to the
strategy discussed above for the corresponding direct effect. An efficient
estimator can be computed as a contrast between the interventions <span class="math inline">\((a' = 1, a^{\star} = 0)\)</span> and <span class="math inline">\((a' = 1, a^{\star} = 1)\)</span>. Specifically, our efficient
estimators of the interventional indirect effect proceed by constructing
estimators <span class="math inline">\(\hat{\theta}(a' = 1, a^{\star} = 0)\)</span> and <span class="math inline">\(\hat{\theta}(a' = 1, a^{\star} = 1)\)</span>. Then, application of the delta method yields an efficient
estimator of the indirect effect, that is, <span class="math inline">\(\hat{\theta}^{\text{IE}} = \hat{\theta}(a' = 1, a^{\star} = 0) - \hat{\theta}(a' = 1, a^{\star} = 1)\)</span>. The
same principle may be applied to the EIF estimates to derive variance estimates
and construct asymptotically correct Wald-style confidence intervals for
<span class="math inline">\(\hat{\theta}^{\text{IE}}\)</span>.</p>
<p>Now, we examine the one-step estimator of the interventional indirect effect.
The one-step estimator is constructed by adding the mean of the EIF
(evaluated at initial estimates of the nuisance parameters) to the substitution
estimator. As noted above, this is done separately for each of the two contrasts
<span class="math inline">\((a' = 1, a^{\star} = 1)\)</span> and <span class="math inline">\((a' = 1, a^{\star} = 0)\)</span>. Thus, the one-step
estimator of this indirect effect is constructed by application of the delta
method to each of the one-step estimators (and EIFs) for the contrasts.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># compute one-step estimate of the interventional indirect effect</span>
<span class="va">os_ie</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/medoutcon/man/medoutcon.html">medoutcon</a></span><span class="op">(</span>
  W <span class="op">=</span> <span class="va">example_data</span><span class="op">[</span>, <span class="va">..w_names</span><span class="op">]</span>,
  A <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">A</span>,
  Z <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">Z</span>,
  M <span class="op">=</span> <span class="va">example_data</span><span class="op">[</span>, <span class="va">..m_names</span><span class="op">]</span>,
  Y <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">Y</span>,
  g_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  h_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  b_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  q_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  r_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  effect <span class="op">=</span> <span class="st">"indirect"</span>,
  estimator <span class="op">=</span> <span class="st">"onestep"</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">os_ie</span><span class="op">)</span></code></pre></div>
<p>As before, let’s compare the one-step estimate to the TML estimate. Analogous
to the case of the one-step estimator, the TML estimator can be evaluated via a
single call to the <code>medoutcon</code> function, as demonstrated below</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># compute targeted minimum loss estimate of the interventional indirect effect</span>
<span class="va">tmle_ie</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/medoutcon/man/medoutcon.html">medoutcon</a></span><span class="op">(</span>
  W <span class="op">=</span> <span class="va">example_data</span><span class="op">[</span>, <span class="va">..w_names</span><span class="op">]</span>,
  A <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">A</span>,
  Z <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">Z</span>,
  M <span class="op">=</span> <span class="va">example_data</span><span class="op">[</span>, <span class="va">..m_names</span><span class="op">]</span>,
  Y <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">Y</span>,
  g_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  h_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  b_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  q_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  r_learners <span class="op">=</span> <span class="va">sl_lrnr</span>,
  effect <span class="op">=</span> <span class="st">"indirect"</span>,
  estimator <span class="op">=</span> <span class="st">"tmle"</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">tmle_ie</span><span class="op">)</span></code></pre></div>
<p>As before, the TML estimator provides better finite-sample performance than the
one-step estimator, so it may be preferred in this example.</p>

</div>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="using-the-eif-to-construct-an-estimator-the-case-of-the-natural-direct-effect.html"><span class="header-section-number">6</span> Using the EIF to construct an estimator: the case of the natural direct effect</a></div>
<div class="next"><a href="references.html">References</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#estimating-indirect-effects-with-r-packages"><span class="header-section-number">7</span> Estimating (in)direct effects with R packages</a></li>
<li>
<a class="nav-link" href="#medshift-stochastic-indirect-effects"><span class="header-section-number">7.1</span> medshift: Stochastic (in)direct effects</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#decomposing-the-population-intervention-effect"><span class="header-section-number">7.1.1</span> Decomposing the population intervention effect</a></li>
<li><a class="nav-link" href="#estimating-the-effect-decomposition-term"><span class="header-section-number">7.1.2</span> Estimating the effect decomposition term</a></li>
<li><a class="nav-link" href="#estimating-the-direct-effect"><span class="header-section-number">7.1.3</span> Estimating the direct effect</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#medoutcon-naturalinterventional-effects"><span class="header-section-number">7.2</span> medoutcon: Natural/Interventional Effects</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#problem-setup-and-notation"><span class="header-section-number">7.2.1</span> Problem Setup and Notation</a></li>
<li><a class="nav-link" href="#interventional-indirect-effects-1"><span class="header-section-number">7.2.2</span> Interventional (In)Direct Effects</a></li>
<li><a class="nav-link" href="#efficient-estimation"><span class="header-section-number">7.2.3</span> Efficient Estimation</a></li>
<li><a class="nav-link" href="#data-analysis-example"><span class="header-section-number">7.2.4</span> Data Analysis Example</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/nhejazi/ser2021_mediation_workshop/blob/master/07-estimation-stochastic.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/nhejazi/ser2021_mediation_workshop/edit/master/07-estimation-stochastic.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>[SER 2021 Workshop] Causal Mediation: Modern Methods for Path Analysis</strong>" was written by Iván Díaz, Nima Hejazi, Kara Rudolph. It was last built on updated: May 15, 2021.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
